<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch ƒê∆°n H√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-50 to-orange-50">
    <div class="p-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-pink-500 to-orange-400 p-6">
                <div class="flex items-center justify-between mb-4">
                    <a href="index.html" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        ‚Üê T·∫°o ƒë∆°n
                    </a>
                    <h1 class="text-2xl font-bold text-white flex-1 text-center">
                        üìã Danh S√°ch ƒê∆°n H√†ng
                    </h1>
                    <button id="refreshBtn" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                        üîÑ L√†m m·ªõi
                    </button>
                </div>
                
                <!-- Sheet Selector -->
                <div class="bg-white/10 rounded-lg p-4">
                    <label class="block text-white text-sm font-medium mb-2">
                        Ch·ªçn b·∫£ng d·ªØ li·ªáu:
                    </label>
                    <select id="sheetSelector" class="w-full px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white outline-none text-gray-800 font-medium">
                        <option value="">ƒêang t·∫£i danh s√°ch sheets...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-pink-500 border-t-transparent"></div>
            <p class="mt-4 text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMsg" class="hidden bg-red-50 border-2 border-red-200 rounded-xl p-6 text-center">
            <p class="text-red-700 font-medium">‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p>
            <p class="text-red-600 text-sm mt-2" id="errorText"></p>
            <button onclick="loadSelectedSheet()" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition">
                Th·ª≠ l·∫°i
            </button>
        </div>

        <!-- Stats -->
        <div id="stats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl p-4 shadow-lg">
                <p class="text-gray-600 text-sm">T·ªïng ƒë∆°n</p>
                <p class="text-2xl font-bold text-pink-600" id="totalOrders">0</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg">
                <p class="text-gray-600 text-sm">ƒê√£ thanh to√°n</p>
                <p class="text-2xl font-bold text-green-600" id="paidOrders">0</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg">
                <p class="text-gray-600 text-sm">Ch∆∞a thanh to√°n</p>
                <p class="text-2xl font-bold text-orange-600" id="unpaidOrders">0</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg">
                <p class="text-gray-600 text-sm">T·ªïng doanh thu</p>
                <p class="text-2xl font-bold text-purple-600" id="totalRevenue">0ƒë</p>
            </div>
        </div>

        <!-- Orders List -->
        <div id="ordersList" class="hidden space-y-4">
            <!-- Orders will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden bg-white rounded-xl p-12 text-center shadow-lg">
            <p class="text-6xl mb-4">üéÇ</p>
            <p class="text-gray-600 text-lg">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong sheet n√†y</p>
            <a href="index.html" class="inline-block mt-4 bg-gradient-to-r from-pink-500 to-orange-400 text-white px-6 py-3 rounded-lg hover:from-pink-600 hover:to-orange-500 transition">
                T·∫°o ƒë∆°n h√†ng m·ªõi
            </a>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzIKlkryJvmaUHB5tFMvjwObJSww6ecqDBTDz_eFQAeVQUCmBk_PnbIRLUx8LpAh3qK/exec';
        const SPREADSHEET_ID = '1swxvw6EKKoskgqtypSSlhfWz_2_GeRBws2VEMmzJluY';
        
        let currentSheets = [];

        // ‚úÖ JSONP request to bypass CORS (works 100% with Google Apps Script)
        async function fetchGoogleAppsScript(data) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(response);
                };
                
                const params = new URLSearchParams({
                    callback: callbackName,
                    data: JSON.stringify(data)
                });
                
                const script = document.createElement('script');
                script.src = `${API_URL}?${params.toString()}`;
                script.onerror = function() {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Failed to load script'));
                };
                
                document.body.appendChild(script);
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (script.parentNode) {
                            document.body.removeChild(script);
                        }
                        reject(new Error('Request timeout'));
                    }
                }, 30000);
            });
        }

        // Load sheets list on page load
        window.addEventListener('DOMContentLoaded', loadSheetsList);
        
        // Handle sheet selection
        document.getElementById('sheetSelector').addEventListener('change', function() {
            if (this.value) {
                loadSelectedSheet();
            }
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadSelectedSheet);

        async function loadSheetsList() {
            try {
                const data = await fetchGoogleAppsScript({
                    action: 'listSheets',
                    spreadsheetId: SPREADSHEET_ID
                });
                
                console.log('Sheets response:', data);
                
                if (data.status === 'success' && data.sheets) {
                    currentSheets = data.sheets;
                    populateSheetSelector(data.sheets);
                } else {
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y danh s√°ch sheets');
                }
            } catch (error) {
                console.error('Error loading sheets:', error);
                document.getElementById('sheetSelector').innerHTML = '<option value="">‚ùå L·ªói t·∫£i danh s√°ch</option>';
            }
        }

        function populateSheetSelector(sheets) {
            const selector = document.getElementById('sheetSelector');
            selector.innerHTML = '<option value="">-- Ch·ªçn sheet --</option>';
            
            sheets.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.name;
                option.textContent = sheet.name;
                selector.appendChild(option);
            });

            // Auto select first sheet
            if (sheets.length > 0) {
                selector.value = sheets[0].name;
                loadSelectedSheet();
            }
        }

        async function loadSelectedSheet() {
            const sheetName = document.getElementById('sheetSelector').value;
            
            if (!sheetName) {
                return;
            }

            showLoading();
            
            try {
                const data = await fetchGoogleAppsScript({
                    action: 'getRows',
                    spreadsheetId: SPREADSHEET_ID,
                    sheetName: sheetName
                });
                
                console.log('Orders response:', data);
                
                if (data.status === 'success' && data.rows) {
                    displayOrders(data.rows);
                } else {
                    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showError(error.message);
            }
        }

        function displayOrders(rows) {
            hideLoading();
            
            if (!rows || rows.length === 0) {
                showEmptyState();
                return;
            }

            // Rows are already objects with keys as headers
            const orders = rows;

            if (orders.length === 0) {
                showEmptyState();
                return;
            }

            // Calculate stats
            const totalOrders = orders.length;
            let paidOrders = 0;
            let totalRevenue = 0;

            orders.forEach(order => {
                if (order['Tr·∫°ng th√°i thanh to√°n'] === 'ƒê√£ thanh to√°n') paidOrders++;
                totalRevenue += parseInt(order['T·ªïng ti·ªÅn']) || 0;
            });

            const unpaidOrders = totalOrders - paidOrders;

            // Update stats
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('paidOrders').textContent = paidOrders;
            document.getElementById('unpaidOrders').textContent = unpaidOrders;
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString('vi-VN') + 'ƒë';
            document.getElementById('stats').classList.remove('hidden');

            // Display orders
            const ordersListDiv = document.getElementById('ordersList');
            ordersListDiv.innerHTML = '';
            
            orders.forEach((order, index) => {
                const isPaid = order['Tr·∫°ng th√°i thanh to√°n'] === 'ƒê√£ thanh to√°n';
                const isCash = order['Ph∆∞∆°ng th·ª©c thanh to√°n'] === 'Ti·ªÅn m·∫∑t';
                
                const orderCard = `
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${order['T√™n b√°nh'] || 'N/A'}</h3>
                                <p class="text-sm text-gray-500">Size: ${order['K√≠ch c·ª°'] || 'N/A'} cm ‚Ä¢ SL: ${order['S·ªë l∆∞·ª£ng'] || 'N/A'}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${isPaid ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                ${isPaid ? '‚úÖ ƒê√£ thanh to√°n' : '‚è≥ Ch∆∞a thanh to√°n'}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">Gi√° ti·ªÅn</p>
                                <p class="font-semibold text-gray-800">${parseInt(order['Gi√° ti·ªÅn'] || 0).toLocaleString('vi-VN')}ƒë</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">T·ªïng ti·ªÅn</p>
                                <p class="font-bold text-pink-600 text-lg">${parseInt(order['T·ªïng ti·ªÅn'] || 0).toLocaleString('vi-VN')}ƒë</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="text-sm ${isCash ? 'text-green-600' : 'text-blue-600'}">
                                    ${isCash ? 'üíµ Ti·ªÅn m·∫∑t' : 'üè¶ Chuy·ªÉn kho·∫£n'}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${order['Ng√†y t·∫°o'] ? formatDate(order['Ng√†y t·∫°o']) : 'N/A'}
                            </div>
                        </div>
                    </div>
                `;
                
                ordersListDiv.innerHTML += orderCard;
            });
            
            ordersListDiv.classList.remove('hidden');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            // Handle various date formats
            let date;
            if (dateString.includes('T')) {
                date = new Date(dateString);
            } else {
                // Assume DD/MM/YYYY HH:MM format
                const parts = dateString.split(' ');
                if (parts.length === 2) {
                    const dateParts = parts[0].split('/');
                    const timeParts = parts[1].split(':');
                    date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1]);
                } else {
                    return dateString;
                }
            }
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            document.getElementById('ordersList').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            hideLoading();
            document.getElementById('errorMsg').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }

        function showEmptyState() {
            hideLoading();
            document.getElementById('emptyState').classList.remove('hidden');
        }
    </script>
</body>
</html>
